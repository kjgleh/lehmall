üóÇÔ∏è MovieEntity.kt

import jakarta.persistence.*

@Entity
@Table(name = "movie")
class MovieEntity(
@Id @GeneratedValue
val id: Long? = null,

      val title: String,

      val fee: Int,

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "discount_policy_id")
      val discountPolicy: DiscountPolicyEntity?

)

üóÇÔ∏è DiscountPolicyEntity.kt

import jakarta.persistence.*

enum class PolicyType { AMOUNT, PERCENT, OVERLAPPED }

@Entity
@Table(name = "discount_policy")
class DiscountPolicyEntity(
@Id @GeneratedValue
val id: Long? = null,

      @Enumerated(EnumType.STRING)
      val policyType: PolicyType,

      val amount: Int?,
      val percent: Double?,

      @OneToMany(mappedBy = "policy", fetch = FetchType.LAZY)
      val conditions: List<DiscountConditionEntity> = emptyList()

)

üóÇÔ∏è DiscountConditionEntity.kt

import jakarta.persistence.*
import java.time.DayOfWeek
import java.time.LocalTime

enum class ConditionType { SEQUENCE, PERIOD }

@Entity
@Table(name = "discount_condition")
class DiscountConditionEntity(
@Id @GeneratedValue
val id: Long? = null,

      @Enumerated(EnumType.STRING)
      val conditionType: ConditionType,

      val sequence: Int?,
      @Enumerated(EnumType.STRING)
      val dayOfWeek: DayOfWeek?,
      val startTime: LocalTime?,
      val endTime: LocalTime?,

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "policy_id")
      val policy: DiscountPolicyEntity

)

‚Äî‚Äî‚Äî

üß† ÎèÑÎ©îÏù∏(Í∏∞Ï°¥ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ïú†ÏßÄ)

```kotlin
interface DiscountPolicy {
    fun calculateDiscount(screening: Screening): Money
}

class AmountDiscountPolicy(
    private val amount: Money,
    private val conditions: List<DiscountCondition>
) : DiscountPolicy {
    override fun calculateDiscount(screening: Screening): Money {
        return if (conditions.any { it.isSatisfiedBy(screening) }) amount else Money.ZERO
    }
}

class PercentDiscountPolicy(
    private val percent: Double,
    private val conditions: List<DiscountCondition>
) : DiscountPolicy {
    override fun calculateDiscount(screening: Screening): Money {
        return if (conditions.any { it.isSatisfiedBy(screening) }) screening.getMovieFee()
            .times(percent) else Money.ZERO
    }
}
```

‚Äî‚Äî‚Äî

üß© Ï°∞Î¶ΩÍ∏∞(ÏóîÌã∞Ìã∞ ‚Üí ÎèÑÎ©îÏù∏)

```kotlin
class MovieAssembler {
    fun toDomain(entity: MovieEntity): Movie {
        val policy = entity.discountPolicy?.let { toPolicy(it) }
        return Movie(entity.id, entity.title, Money.wons(entity.fee), policy)
    }

    private fun toPolicy(entity: DiscountPolicyEntity): DiscountPolicy {
        val conditions = entity.conditions.map { toCondition(it) }
        return when (entity.policyType) {
            PolicyType.AMOUNT -> AmountDiscountPolicy(Money.wons(entity.amount!!), conditions)
            PolicyType.PERCENT -> PercentDiscountPolicy(entity.percent!!, conditions)
            PolicyType.OVERLAPPED -> OverlappedDiscountPolicy(
                listOf(
                    AmountDiscountPolicy(Money.wons(entity.amount!!), conditions),
                    PercentDiscountPolicy(entity.percent!!, conditions)
                )
            )
        }
    }

    private fun toCondition(entity: DiscountConditionEntity): DiscountCondition {
        return when (entity.conditionType) {
            ConditionType.SEQUENCE -> SequenceCondition(entity.sequence!!)
            ConditionType.PERIOD -> PeriodCondition(
                entity.dayOfWeek!!, entity.startTime!!, entity.endTime!!
            )
        }
    }
}
```

## Îã§Î•∏ Î∞©Ïãù

```kotlin
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "policy_type")
abstract class DiscountPolicy(
    @Id @GeneratedValue val id: Long? = null
) {
    abstract fun calculateDiscount(screening: Screening): Money
}

@Entity
@DiscriminatorValue("AMOUNT")
class AmountDiscountPolicy(
    val amount: Int
) : DiscountPolicy() {
    override fun calculateDiscount(screening: Screening): Money {
        return Money.wons(amount)
    }
}

@Entity
class Movie(
    @Id @GeneratedValue val id: Long? = null,
    val title: String,
    val fee: Int,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "discount_policy_id")
    val discountPolicy: DiscountPolicy
) {
    fun calculateFee(screening: Screening): Money {
        return Money.wons(fee).minus(discountPolicy.calculateDiscount(screening))
    }
}


```
